<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uintas üíØ</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Offline guide to over 500 fishable lakes in Utah's Uinta Mountains with fishing data and stocking records">
    <meta name="theme-color" content="#334155">
    
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Uintas üíØ">
    <link rel="apple-touch-icon" sizes="180x180" href="/icon-180.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        .loading { display: none; }
        .loaded .loading { display: block; }
        .loaded .not-loaded { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Uintas üíØ</h1>
            <p class="text-gray-600">500+ fishable lakes ‚Ä¢ 18 drainages</p>
        </header>

        <div class="not-loaded">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-400 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading database...</p>
            </div>
        </div>

        <div class="loading">
            <!-- Main Content -->
            <div class="space-y-6">
                <!-- Search Section -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Find a Lake</h2>
                    
                    <!-- Lake Name Search -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lake Name or Designation</label>
                        <input type="text" id="lake-search" placeholder="Start typing lake name or designation (e.g., Bear, G-7)" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500"
                               autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                        <div id="search-results" class="mt-2 bg-white border border-gray-200 rounded-md hidden max-h-60 overflow-y-auto"></div>
                    </div>

                    <div class="text-center text-gray-500 mb-4">OR</div>

                    <!-- Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Drainage</label>
                            <select id="drainage-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-500">
                                <option value="">All drainages</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fish Species</label>
                            <select id="species-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-500">
                                <option value="">Any species</option>
                                <option value="brookies">Brookies</option>
                                <option value="tigers">Tigers</option>
                                <option value="cutthroats">Cutthroats</option>
                                <option value="rainbows">Rainbows</option>
                                <option value="goldens">Goldens</option>
                                <option value="grayling">Grayling</option>
                                <option value="splake">Splake</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Depth (feet)</label>
                            <div class="flex gap-2">
                                <input type="number" id="depth-min" placeholder="Min" min="0" max="200" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-500 text-sm">
                                <input type="number" id="depth-max" placeholder="Max" min="0" max="200" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-500 text-sm">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Elevation (feet)</label>
                            <div class="flex gap-2">
                                <input type="number" id="elevation-min" placeholder="Min" min="8000" max="12000" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-500 text-sm">
                                <input type="number" id="elevation-max" placeholder="Max" min="8000" max="12000" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-500 text-sm">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Size (acres)</label>
                            <div class="flex gap-2">
                                <input type="number" id="size-min" placeholder="Min" min="0" max="300" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-500 text-sm">
                                <input type="number" id="size-max" placeholder="Max" min="0" max="300" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-500 text-sm">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stocked Years</label>
                            <div class="flex gap-2">
                                <input type="number" id="year-min" placeholder="Min" min="2002" max="2025" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-500 text-sm">
                                <input type="number" id="year-max" placeholder="Max" min="2002" max="2025" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-slate-500 text-sm">
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 space-y-2">
                        <button id="apply-filters" class="w-full bg-gray-300 text-gray-500 px-4 py-2 rounded-lg cursor-not-allowed transition-colors" disabled>
                            Apply Filters
                        </button>
                        <button id="clear-filters" class="w-full text-slate-600 hover:text-slate-800 text-sm hidden transition-colors">
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Drainages Section -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Browse by Drainage</h2>
                    <div id="drainages-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <!-- Drainage links will be populated here -->
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-section" class="hidden">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Results</h2>
                        <div id="results-list" class="space-y-4">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Lake Detail Modal -->
                <div id="lake-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 id="modal-title" class="text-2xl font-bold"></h2>
                                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                                </div>
                                <div id="modal-content" class="space-y-6">
                                    <!-- Lake details will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- About Modal -->
                <div id="about-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                            <div class="p-8">
                                <div class="flex justify-between items-center mb-6">
                                    <h1 class="text-3xl font-bold text-gray-800">About This Project</h1>
                                    <button id="close-about-modal" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
                                </div>
                                
                                <div class="space-y-8">
                                    <div class="text-lg leading-relaxed p-6 bg-gray-50 rounded-lg border-l-4 border-gray-400">
                                        I'm on a mission to catch a fish out of at least 100 different Uintas waters. I grew up in Provo fishing and camping all over, but somehow never in the Uintas. At the ripe age of 42 I spent a week on the Highline trail and realized what I've been missing.
                                    </div>

                                    <div>
                                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Sources of Information & Inspiration</h2>
                                        
                                        <div class="space-y-6">
                                            <div>
                                                <h3 class="text-xl font-semibold text-gray-700 mb-3">Websites</h3>
                                                <ul class="space-y-2 ml-4">
                                                    <li><a href="https://junesucker.com/uintas" target="_blank" class="text-slate-700 underline hover:text-slate-900">Junesucker.com</a></li>
                                                    <li><a href="https://dwrapps.utah.gov/fishstocking/Fish" target="_blank" class="text-slate-700 underline hover:text-slate-900">DWR Stocking Reports</a></li>
                                                </ul>
                                            </div>

                                            <div>
                                                <h3 class="text-xl font-semibold text-gray-700 mb-3">YouTube Channels</h3>
                                                <ul class="space-y-2 ml-4">
                                                    <li><a href="https://www.youtube.com/@TroutHowler" target="_blank" class="text-slate-700 underline hover:text-slate-900">TroutHowler</a></li>
                                                    <li><a href="https://www.youtube.com/@UtahWaterLog" target="_blank" class="text-slate-700 underline hover:text-slate-900">Utah Water Log</a></li>
                                                </ul>
                                            </div>

                                            <div>
                                                <h3 class="text-xl font-semibold text-gray-700 mb-3">Books</h3>
                                                <ul class="space-y-2 ml-4">
                                                    <li><a href="https://www.amazon.com/Hiking-Utahs-Uintas-Andrew-Gillman/dp/1493075691" target="_blank" class="text-slate-700 underline hover:text-slate-900">Hiking Utah's High Uintas</a></li>
                                                    <li><a href="https://www.amazon.com/High-Uintas-Adventures-Backcountry-Planner/dp/B08FPGJ214" target="_blank" class="text-slate-700 underline hover:text-slate-900">High Uintas Adventures</a></li>
                                                </ul>
                                            </div>

                                            <div>
                                                <h3 class="text-xl font-semibold text-gray-700 mb-3">Old DWR Pamphlets</h3>
                                                <ul class="space-y-2 ml-4">
                                                    <li><a href="data/dwr_original_pamphlets/dwr-bear-blacks-fork.pdf" target="_blank" class="text-slate-700 underline hover:text-slate-900">Bear River & Blacks Fork Drainages</a></li>
                                                    <li><a href="data/dwr_original_pamphlets/dwr-dry-gulch-and-uinta.pdf" target="_blank" class="text-slate-700 underline hover:text-slate-900">Dry Gulch & Uinta River Drainages</a></li>
                                                    <li><a href="data/dwr_original_pamphlets/dwr-duchesne.pdf" target="_blank" class="text-slate-700 underline hover:text-slate-900">Duchesne River Drainage</a></li>
                                                    <li><a href="data/dwr_original_pamphlets/dwr-provo-weber.pdf" target="_blank" class="text-slate-700 underline hover:text-slate-900">Provo River & Weber River Drainages</a></li>
                                                    <li><a href="data/dwr_original_pamphlets/dwr-sheep-carter-burnt-fork.pdf" target="_blank" class="text-slate-700 underline hover:text-slate-900">Sheep Creek, Carter Creek & Burnt Fork Drainages</a></li>
                                                    <li><a href="data/dwr_original_pamphlets/dwr-smith-henry-beaver.pdf" target="_blank" class="text-slate-700 underline hover:text-slate-900">Smiths Fork, Henrys Fork & Beaver Creek Drainages</a></li>
                                                    <li><a href="data/dwr_original_pamphlets/dwr-uintas-rock-creek.pdf" target="_blank" class="text-slate-700 underline hover:text-slate-900">Uinta River & Rock Creek Drainages</a></li>
                                                    <li><a href="data/dwr_original_pamphlets/dwr-yellowstone-lake-fork-swift.pdf" target="_blank" class="text-slate-700 underline hover:text-slate-900">Yellowstone River, Lake Fork & Swift Creek Drainages</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Fun Facts</h2>
                                        <div class="space-y-6">
                                            <p class="text-lg leading-relaxed">
                                                There are around 500 lakes in the Uintas with fish in them, and a couple hundred without. Many are stocked regularly, some were stocked years ago and have established naturally reproducing populations, some have no fish and likely never have, and some were once stocked but they gave up due to frequent winter kill.
                                            </p>
                                            
                                            <div>
                                                <h3 class="text-xl font-semibold text-gray-700 mb-3">Deep and High</h3>
                                                <ul class="space-y-2 ml-4">
                                                    <li><strong>Deepest:</strong> Crater (X-94) at 147 feet</li>
                                                    <li><strong>Highest elevation:</strong> Beard (U-74) at 11,740 feet</li>
                                                </ul>
                                            </div>

                                            <div>
                                                <h3 class="text-xl font-semibold text-gray-700 mb-3">Popular Names</h3>
                                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
                                                    <div><strong>Hidden</strong> (6 lakes)</div>
                                                    <div><strong>Island</strong> (4 lakes)</div>
                                                    <div><strong>Beaver</strong> (3 lakes)</div>
                                                    <div><strong>Blue</strong> (3 lakes)</div>
                                                    <div><strong>Castle</strong> (3 lakes)</div>
                                                    <div><strong>Cliff</strong> (3 lakes)</div>
                                                    <div><strong>Fish</strong> (3 lakes)</div>
                                                    <div><strong>Lily Pad</strong> (3 lakes)</div>
                                                    <div><strong>Lost</strong> (3 lakes)</div>
                                                    <div><strong>Bear</strong> (2 lakes)</div>
                                                    <div><strong>Brook</strong> (2 lakes)</div>
                                                    <div><strong>Carol</strong> (2 lakes)</div>
                                                    <div><strong>Cleveland</strong> (2 lakes)</div>
                                                    <div><strong>Crater</strong> (2 lakes)</div>
                                                    <div><strong>Crystal</strong> (2 lakes)</div>
                                                    <div><strong>Dean</strong> (2 lakes)</div>
                                                    <div><strong>Diamond</strong> (2 lakes)</div>
                                                    <div><strong>Dollar</strong> (2 lakes)</div>
                                                    <div><strong>Duck</strong> (2 lakes)</div>
                                                    <div><strong>Everman</strong> (2 lakes)</div>
                                                    <div><strong>Gem</strong> (2 lakes)</div>
                                                    <div><strong>Gilbert</strong> (2 lakes)</div>
                                                    <div><strong>Hell Hole</strong> (2 lakes)</div>
                                                    <div><strong>Horseshoe</strong> (2 lakes)</div>
                                                    <div><strong>Jean</strong> (2 lakes)</div>
                                                    <div><strong>Lambert</strong> (2 lakes)</div>
                                                    <div><strong>Lilly</strong> (2 lakes)</div>
                                                    <div><strong>Lily</strong> (2 lakes)</div>
                                                    <div><strong>Little Elk</strong> (2 lakes)</div>
                                                    <div><strong>Marsh</strong> (2 lakes)</div>
                                                    <div><strong>Milk</strong> (2 lakes)</div>
                                                    <div><strong>Mud</strong> (2 lakes)</div>
                                                    <div><strong>Olsen</strong> (2 lakes)</div>
                                                    <div><strong>Porcupine</strong> (2 lakes)</div>
                                                    <div><strong>Rainbow</strong> (2 lakes)</div>
                                                    <div><strong>Round</strong> (2 lakes)</div>
                                                    <div><strong>Sand</strong> (2 lakes)</div>
                                                    <div><strong>Twin</strong> (2 lakes)</div>
                                                </div>
                                                
                                                <p class="text-sm text-gray-600 mt-4 italic">
                                                    There's an X-22 in both Rock Creek Drainage (Pinto) and Swift Creek Drainage, which can cause some confusion when referencing lakes by number alone.
                                                </p>
                                            </div>

                                            <div>
                                                <h3 class="text-xl font-semibold text-gray-700 mb-3">2025 Stocking Totals</h3>
                                                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                                        <div class="text-2xl font-bold text-gray-800">96,000</div>
                                                        <div class="text-sm text-gray-600">Brookies</div>
                                                    </div>
                                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                                        <div class="text-2xl font-bold text-gray-800">63,000</div>
                                                        <div class="text-sm text-gray-600">Rainbows</div>
                                                    </div>
                                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                                        <div class="text-2xl font-bold text-gray-800">28,000</div>
                                                        <div class="text-sm text-gray-600">Tigers</div>
                                                    </div>
                                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                                        <div class="text-2xl font-bold text-gray-800">27,000</div>
                                                        <div class="text-sm text-gray-600">Cutthroats</div>
                                                    </div>
                                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                                        <div class="text-2xl font-bold text-gray-800">4,000</div>
                                                        <div class="text-sm text-gray-600">Grayling</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="pb-8"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- About Link -->
            <div class="mt-8 text-center">
                <button id="about-link" class="text-slate-600 hover:text-slate-800 text-sm transition-colors underline cursor-pointer bg-transparent border-none">About this project</button>
            </div>
        </div>
    </div>

    <script>
        let db = null;
        let lakes = [];
        let stockingRecords = [];

        function getStatusButton(status, isDisplay = false) {
            const buttonClass = isDisplay ? 
                "inline-flex items-center px-2 py-1 border border-slate-300 rounded-md text-sm" :
                "inline-flex items-center px-3 py-2 border border-slate-300 rounded-lg text-sm hover:bg-slate-50 transition-colors";
            
            switch(status) {
                case 'CAUGHT':
                    return `<span class="${buttonClass}">üé£</span>`;
                case 'NONE':
                    return `<span class="${buttonClass}">‚úñÔ∏è</span>`;
                case 'OTHERS':
                    return `<span class="${buttonClass}">üë•üé£</span>`;
                default:
                    return status;
            }
        }

        // Initialize the app
        async function initApp() {
            try {
                // Load sql.js with fallback for offline
                let SQL;
                try {
                    SQL = await initSqlJs({
                        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                    });
                } catch (cdnError) {
                    console.warn('CDN failed, trying to load from cache:', cdnError);
                    // Service worker should have cached these files
                    throw cdnError;
                }

                // Load database file with better error handling
                let buffer;
                try {
                    const response = await fetch('uinta_lakes.db');
                    if (!response.ok) {
                        throw new Error(`Database fetch failed: ${response.status}`);
                    }
                    buffer = await response.arrayBuffer();
                } catch (fetchError) {
                    console.error('Failed to load database:', fetchError);
                    throw new Error('Database file not accessible. Make sure you are connected to the internet for the first load.');
                }
                
                const uint8Array = new Uint8Array(buffer);
                db = new SQL.Database(uint8Array);

                // Verify database loaded correctly
                try {
                    const testQuery = db.exec('SELECT COUNT(*) as count FROM lakes');
                    const lakeCount = testQuery[0].values[0][0];
                    console.log(`Database loaded successfully: ${lakeCount} lakes`);
                } catch (dbError) {
                    throw new Error('Database appears corrupted or invalid');
                }

                // Load all data into memory for fast filtering
                await loadData();
                
                // Initialize UI
                initializeUI();
                populateDrainages();
                
                // Mark as loaded
                document.body.classList.add('loaded');
                
            } catch (error) {
                console.error('Failed to initialize app:', error);
                
                // Show user-friendly error message
                const errorMsg = error.message.includes('Database file not accessible') 
                    ? error.message 
                    : 'Failed to load the lake database. Please refresh the page or check your connection.';
                
                document.querySelector('.not-loaded p').textContent = errorMsg;
                document.querySelector('.animate-spin').style.display = 'none';
            }
        }

        async function loadData() {
            // Load lakes
            const lakesResult = db.exec(`
                SELECT id, letter_number, name, drainage, size_acres, max_depth_ft, 
                       elevation_ft, fish_species, fishing_pressure, jed_notes, status, junesucker_notes, dwr_notes, no_fish
                FROM lakes
            `);
            
            if (lakesResult.length > 0) {
                lakes = lakesResult[0].values.map(row => ({
                    id: row[0],
                    letter_number: row[1],
                    name: row[2],
                    drainage: row[3],
                    size_acres: row[4],
                    max_depth_ft: row[5],
                    elevation_ft: row[6],
                    fish_species: row[7],
                    fishing_pressure: row[8],
                    jed_notes: row[9],
                    status: row[10],
                    junesucker_notes: row[11],
                    dwr_notes: row[12],
                    no_fish: row[13]
                }));
                
                // Sort lakes using letter_number as name fallback for proper alphabetical ordering
                lakes.sort((a, b) => {
                    const nameA = (a.name || a.letter_number || '').toLowerCase();
                    const nameB = (b.name || b.letter_number || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
            }

            // Load stocking records
            const stockingResult = db.exec(`
                SELECT lake_id, species, quantity, length, stock_date, county
                FROM stocking_records ORDER BY stock_date DESC
            `);
            
            if (stockingResult.length > 0) {
                stockingRecords = stockingResult[0].values.map(row => ({
                    lake_id: row[0],
                    species: row[1],
                    quantity: row[2],
                    length: row[3],
                    stock_date: row[4],
                    county: row[5]
                }));
            }

            // Load drainage info
            const drainagesResult = db.exec(`
                SELECT name, info, map FROM drainages ORDER BY name
            `);
            
            if (drainagesResult.length > 0) {
                window.drainages = drainagesResult[0].values.map(row => ({
                    name: row[0],
                    info: row[1],
                    map: row[2]
                }));
            }

            // Load photos
            const photosResult = db.exec(`
                SELECT lake_id, filename, downloaded_path FROM photos ORDER BY filename
            `);
            
            if (photosResult.length > 0) {
                window.photos = photosResult[0].values.map(row => ({
                    lake_id: row[0],
                    filename: row[1],
                    downloaded_path: row[2]
                }));
            } else {
                window.photos = [];
            }
        }

        function initializeUI() {
            // Populate drainage filter
            const drainageFilter = document.getElementById('drainage-filter');
            const drainages = [...new Set(lakes.map(lake => lake.drainage))].sort();
            drainages.forEach(drainage => {
                const option = document.createElement('option');
                option.value = drainage;
                option.textContent = drainage;
                drainageFilter.appendChild(option);
            });


            // Event listeners
            document.getElementById('lake-search').addEventListener('input', handleLakeSearch);
            document.getElementById('apply-filters').addEventListener('click', applyFilters);
            document.getElementById('clear-filters').addEventListener('click', clearFilters);
            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('about-link').addEventListener('click', openAboutModal);
            document.getElementById('close-about-modal').addEventListener('click', closeAboutModal);
            
            // Filter state management
            ['drainage-filter', 'species-filter'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateFilterButtonState);
            });
            ['depth-min', 'depth-max', 'elevation-min', 'elevation-max', 'size-min', 'size-max', 'year-min', 'year-max'].forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', updateFilterButtonState);
                element.addEventListener('change', updateFilterButtonState);
            });
        }

        function populateDrainages() {
            const drainagesList = document.getElementById('drainages-list');
            const drainages = [...new Set(lakes.map(lake => lake.drainage))].sort();
            
            drainages.forEach(drainage => {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'block p-3 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-800 hover:text-slate-900 transition-colors';
                const lakeCount = lakes.filter(lake => lake.drainage === drainage).length;
                link.textContent = `${drainage} ‚Ä¢ ${lakeCount}`;
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showDrainageLakes(drainage);
                });
                drainagesList.appendChild(link);
            });
        }

        function handleLakeSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (query.length < 2) {
                resultsDiv.classList.add('hidden');
                return;
            }

            const matches = lakes.filter(lake => {
                const name = (lake.name || '').toLowerCase();
                const designation = lake.letter_number.toLowerCase();
                return name.includes(query) || designation.includes(query);
            }).slice(0, 10);

            if (matches.length > 0) {
                resultsDiv.innerHTML = matches.map(lake => {
                    const noFishEmoji = lake.no_fish ? ' üö´' : '';
                    const opacityClass = lake.no_fish ? 'opacity-60' : '';
                    
                    return `
                    <div class="p-2 hover:bg-slate-50 cursor-pointer border-b last:border-b-0 transition-colors ${opacityClass}" 
                         onclick="showLakeDetail('${lake.letter_number}')">
                        <div class="font-medium">${lake.name ? `${lake.name} ${lake.letter_number}` : lake.letter_number}${noFishEmoji}</div>
                        <div class="text-sm text-gray-600">${lake.drainage}</div>
                    </div>
                    `;
                }).join('');
                resultsDiv.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('hidden');
            }
        }

        function updateFilterButtonState() {
            const drainage = document.getElementById('drainage-filter').value;
            const species = document.getElementById('species-filter').value;
            const depthMin = document.getElementById('depth-min').value;
            const depthMax = document.getElementById('depth-max').value;
            const elevationMin = document.getElementById('elevation-min').value;
            const elevationMax = document.getElementById('elevation-max').value;
            const sizeMin = document.getElementById('size-min').value;
            const sizeMax = document.getElementById('size-max').value;
            const yearMin = document.getElementById('year-min').value;
            const yearMax = document.getElementById('year-max').value;
            
            const applyButton = document.getElementById('apply-filters');
            const hasFilters = drainage || species || depthMin || depthMax || 
                             elevationMin || elevationMax || sizeMin || sizeMax || 
                             yearMin || yearMax;
            
            if (hasFilters) {
                applyButton.disabled = false;
                applyButton.className = "w-full bg-slate-700 text-white px-4 py-2 rounded-lg hover:bg-slate-800 cursor-pointer transition-colors";
            } else {
                applyButton.disabled = true;
                applyButton.className = "w-full bg-gray-300 text-gray-500 px-4 py-2 rounded-lg cursor-not-allowed transition-colors";
            }
        }

        function clearFilters() {
            document.getElementById('drainage-filter').value = '';
            document.getElementById('species-filter').value = '';
            document.getElementById('depth-min').value = '';
            document.getElementById('depth-max').value = '';
            document.getElementById('elevation-min').value = '';
            document.getElementById('elevation-max').value = '';
            document.getElementById('size-min').value = '';
            document.getElementById('size-max').value = '';
            document.getElementById('year-min').value = '';
            document.getElementById('year-max').value = '';
            
            document.getElementById('clear-filters').classList.add('hidden');
            document.getElementById('results-section').classList.add('hidden');
            
            updateFilterButtonState();
        }

        function applyFilters() {
            const drainage = document.getElementById('drainage-filter').value;
            const species = document.getElementById('species-filter').value;
            const depthMin = document.getElementById('depth-min').value;
            const depthMax = document.getElementById('depth-max').value;
            const elevationMin = document.getElementById('elevation-min').value;
            const elevationMax = document.getElementById('elevation-max').value;
            const sizeMin = document.getElementById('size-min').value;
            const sizeMax = document.getElementById('size-max').value;
            const yearMin = document.getElementById('year-min').value;
            const yearMax = document.getElementById('year-max').value;
            
            let filteredLakes = [...lakes];
            
            // Filter by drainage
            if (drainage) {
                filteredLakes = filteredLakes.filter(lake => lake.drainage === drainage);
            }
            
            // Filter by depth range
            if (depthMin || depthMax) {
                filteredLakes = filteredLakes.filter(lake => {
                    if (!lake.max_depth_ft) return false;
                    const depth = lake.max_depth_ft;
                    const minCheck = !depthMin || depth >= parseInt(depthMin);
                    const maxCheck = !depthMax || depth <= parseInt(depthMax);
                    return minCheck && maxCheck;
                });
            }
            
            // Filter by elevation range
            if (elevationMin || elevationMax) {
                filteredLakes = filteredLakes.filter(lake => {
                    if (!lake.elevation_ft) return false;
                    const elevation = lake.elevation_ft;
                    const minCheck = !elevationMin || elevation >= parseInt(elevationMin);
                    const maxCheck = !elevationMax || elevation <= parseInt(elevationMax);
                    return minCheck && maxCheck;
                });
            }
            
            // Filter by size range
            if (sizeMin || sizeMax) {
                filteredLakes = filteredLakes.filter(lake => {
                    if (!lake.size_acres) return false;
                    const size = lake.size_acres;
                    const minCheck = !sizeMin || size >= parseFloat(sizeMin);
                    const maxCheck = !sizeMax || size <= parseFloat(sizeMax);
                    return minCheck && maxCheck;
                });
            }
            
            // Combined species and year filter - this fixes the main issue
            if (species || yearMin || yearMax) {
                filteredLakes = filteredLakes.filter(lake => {
                    const lakeStocking = stockingRecords.filter(s => s.lake_id === lake.id);
                    
                    // If no stocking records, only include if no species or year filters are set
                    if (lakeStocking.length === 0) {
                        // Check if lake has species in fish_species field (for non-stocked natural populations)
                        if (species) {
                            const fishSpecies = (lake.fish_species || '').toLowerCase();
                            return fishSpecies.includes(species.toLowerCase());
                        }
                        return !yearMin && !yearMax; // Only include if no year filters
                    }
                    
                    // Filter stocking records by species if specified
                    let relevantStocking = lakeStocking;
                    if (species) {
                        relevantStocking = lakeStocking.filter(record => 
                            record.species && record.species.toLowerCase().includes(species.toLowerCase())
                        );
                        // If no stocking records match the species, check fish_species field
                        if (relevantStocking.length === 0) {
                            const fishSpecies = (lake.fish_species || '').toLowerCase();
                            if (!fishSpecies.includes(species.toLowerCase())) {
                                return false;
                            }
                            // If fish_species matches but no stocking records, only include if no year filter
                            return !yearMin && !yearMax;
                        }
                    }
                    
                    // Filter by year range
                    if (yearMin || yearMax) {
                        relevantStocking = relevantStocking.filter(record => {
                            const stockYear = parseInt(record.stock_date.split('-')[0]);
                            const minCheck = !yearMin || stockYear >= parseInt(yearMin);
                            const maxCheck = !yearMax || stockYear <= parseInt(yearMax);
                            return minCheck && maxCheck;
                        });
                        return relevantStocking.length > 0;
                    }
                    
                    return true;
                });
            }
            
            // Add stocking year info to results
            const lakesWithStockingInfo = filteredLakes.map(lake => {
                const lakeStocking = stockingRecords.filter(s => s.lake_id === lake.id);
                const stockYears = [...new Set(lakeStocking.map(s => s.stock_date.split('-')[0]))].sort().reverse();
                return {
                    ...lake,
                    stockingYears: stockYears.length > 0 ? stockYears.join(', ') : 'not stocked'
                };
            });
            
            displayFilteredResults(lakesWithStockingInfo);
            
            // Show clear button and reset apply button
            document.getElementById('clear-filters').classList.remove('hidden');
            updateFilterButtonState();
        }
        
        function displayFilteredResults(results) {
            const resultsSection = document.getElementById('results-section');
            const resultsList = document.getElementById('results-list');
            
            // Separate no_fish records
            const withFish = results.filter(lake => !lake.no_fish);
            const noFish = results.filter(lake => lake.no_fish);
            
            const renderLakeCard = (lake) => {
                const noFishEmoji = lake.no_fish ? ' üö´' : '';
                const opacityClass = lake.no_fish ? 'opacity-60' : '';
                const drainageShort = lake.drainage ? lake.drainage.replace(' Drainage', '') : '';
                
                return `
                <div class="border border-slate-200 rounded-lg p-4 hover:bg-slate-50 cursor-pointer transition-colors ${opacityClass}"
                     onclick="showLakeDetail('${lake.letter_number}')">
                    <div class="font-medium text-lg">${lake.name ? `${lake.name} ${lake.letter_number}` : lake.letter_number}${noFishEmoji}</div>
                    <div class="text-sm text-gray-600 mt-1">
                        ${lake.fish_species || ''}
                        ${drainageShort ? `${lake.fish_species ? ' ‚Ä¢ ' : ''}${drainageShort}` : ''}
                        ${lake.size_acres ? ` ‚Ä¢ ${lake.size_acres} acres` : ''} 
                        ${lake.max_depth_ft ? ` ‚Ä¢ ${lake.max_depth_ft} ft deep` : ''}
                        ${lake.elevation_ft ? ` ‚Ä¢ ${lake.elevation_ft.toLocaleString()} ft elev` : ''}
                        ${lake.stockingYears !== 'not stocked' ? ` ‚Ä¢ (${lake.stockingYears})` : ''}
                    </div>
                </div>
                `;
            };
            
            resultsList.innerHTML = `
                <h3 class="text-lg font-semibold mb-4">Filtered Results (${results.length} lakes)</h3>
                ${withFish.map(renderLakeCard).join('')}
                ${noFish.length > 0 ? `
                    <div class="mt-6 pt-4 border-t border-gray-300">
                        <h4 class="text-md font-medium mb-3 text-gray-600">Lakes with No Fish (${noFish.length})</h4>
                        ${noFish.map(renderLakeCard).join('')}
                    </div>
                ` : ''}
            `;
            
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function showDrainageLakes(drainage) {
            const drainageLakes = lakes.filter(lake => lake.drainage === drainage);
            const drainageInfo = window.drainages?.find(d => d.name === drainage);
            
            // Separate no_fish records
            const withFish = drainageLakes.filter(lake => !lake.no_fish);
            const noFish = drainageLakes.filter(lake => lake.no_fish);
            
            const resultsSection = document.getElementById('results-section');
            const resultsList = document.getElementById('results-list');
            
            let drainageContent = '';
            if (drainageInfo) {
                // Convert markdown-style content to HTML
                const infoHtml = drainageInfo.info
                    .replace(/\n\n/g, '</p><p class="mb-4">')
                    .replace(/^/, '<p class="mb-4">')
                    .replace(/$/, '</p>');
                
                drainageContent = `
                    <div class="mb-6 border border-slate-200 rounded-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">${drainage}</h2>
                        ${drainageInfo.map ? `<img src="${drainageInfo.map}" alt="${drainage} Map" class="w-full max-w-2xl mx-auto mb-4 rounded-lg border border-slate-200">` : ''}
                        <div class="text-gray-700 leading-relaxed">
                            ${infoHtml}
                        </div>
                    </div>
                `;
            }
            
            const renderDrainageLakeCard = (lake) => {
                const noFishEmoji = lake.no_fish ? ' üö´' : '';
                const opacityClass = lake.no_fish ? 'opacity-60' : '';
                const lakeStocking = stockingRecords.filter(s => s.lake_id === lake.id);
                const stockYears = [...new Set(lakeStocking.map(s => s.stock_date.split('-')[0]))].sort().reverse();
                const stockingInfo = stockYears.length > 0 ? stockYears.join(', ') : 'not stocked';
                
                return `
                <div class="border border-slate-200 rounded-lg p-4 hover:bg-slate-50 cursor-pointer transition-colors ${opacityClass}"
                     onclick="showLakeDetail('${lake.letter_number}')">
                    <div class="font-medium text-lg">${lake.name ? `${lake.name} ${lake.letter_number}` : lake.letter_number}${noFishEmoji}</div>
                    <div class="text-sm text-gray-600 mt-1">
                        ${lake.fish_species || ''}
                        ${lake.size_acres ? `${lake.fish_species ? ' ‚Ä¢ ' : ''}${lake.size_acres} acres` : ''} 
                        ${lake.max_depth_ft ? ` ‚Ä¢ ${lake.max_depth_ft} ft deep` : ''}
                        ${lake.elevation_ft ? ` ‚Ä¢ ${lake.elevation_ft.toLocaleString()} ft elev` : ''}
                        ${stockingInfo !== 'not stocked' ? ` ‚Ä¢ (${stockingInfo})` : ''}
                    </div>
                </div>
                `;
            };
            
            resultsList.innerHTML = `
                ${drainageContent}
                <h3 class="text-lg font-semibold mb-4">Lakes in ${drainage} (${drainageLakes.length} lakes)</h3>
                ${withFish.map(renderDrainageLakeCard).join('')}
                ${noFish.length > 0 ? `
                    <div class="mt-6 pt-4 border-t border-gray-300">
                        <h4 class="text-md font-medium mb-3 text-gray-600">Lakes with No Fish (${noFish.length})</h4>
                        ${noFish.map(renderDrainageLakeCard).join('')}
                    </div>
                ` : ''}
            `;
            
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayResults(results, title) {
            const resultsSection = document.getElementById('results-section');
            const resultsList = document.getElementById('results-list');
            
            // Separate no_fish records
            const withFish = results.filter(lake => !lake.no_fish);
            const noFish = results.filter(lake => lake.no_fish);
            
            const renderGeneralLakeCard = (lake) => {
                const noFishEmoji = lake.no_fish ? ' üö´' : '';
                const opacityClass = lake.no_fish ? 'opacity-60' : '';
                const drainageShort = lake.drainage ? lake.drainage.replace(' Drainage', '') : '';
                const lakeStocking = stockingRecords.filter(s => s.lake_id === lake.id);
                const stockYears = [...new Set(lakeStocking.map(s => s.stock_date.split('-')[0]))].sort().reverse();
                const stockingInfo = stockYears.length > 0 ? stockYears.join(', ') : 'not stocked';
                
                return `
                <div class="border border-slate-200 rounded-lg p-4 hover:bg-slate-50 cursor-pointer transition-colors ${opacityClass}"
                     onclick="showLakeDetail('${lake.letter_number}')">
                    <div class="font-medium text-lg">${lake.name ? `${lake.name} ${lake.letter_number}` : lake.letter_number}${noFishEmoji}</div>
                    <div class="text-sm text-gray-600 mt-1">
                        ${lake.fish_species || ''}
                        ${drainageShort ? `${lake.fish_species ? ' ‚Ä¢ ' : ''}${drainageShort}` : ''}
                        ${lake.size_acres ? ` ‚Ä¢ ${lake.size_acres} acres` : ''} 
                        ${lake.max_depth_ft ? ` ‚Ä¢ ${lake.max_depth_ft} ft deep` : ''}
                        ${lake.elevation_ft ? ` ‚Ä¢ ${lake.elevation_ft.toLocaleString()} ft elev` : ''}
                        ${stockingInfo !== 'not stocked' ? ` ‚Ä¢ (${stockingInfo})` : ''}
                    </div>
                </div>
                `;
            };
            
            resultsList.innerHTML = `
                <h3 class="text-lg font-semibold mb-4">${title} (${results.length} lakes)</h3>
                ${withFish.map(renderGeneralLakeCard).join('')}
                ${noFish.length > 0 ? `
                    <div class="mt-6 pt-4 border-t border-gray-300">
                        <h4 class="text-md font-medium mb-3 text-gray-600">Lakes with No Fish (${noFish.length})</h4>
                        ${noFish.map(renderGeneralLakeCard).join('')}
                    </div>
                ` : ''}
            `;
            
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function showLakeDetail(letterNumber) {
            const lake = lakes.find(l => l.letter_number === letterNumber);
            if (!lake) return;

            const lakeStocking = stockingRecords.filter(s => s.lake_id === lake.id);
            const lakePhotos = window.photos ? window.photos.filter(p => p.lake_id === lake.id) : [];
            
            const modal = document.getElementById('lake-detail-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            
            const noFishEmoji = lake.no_fish ? ' üö´' : '';
            title.textContent = `${lake.name ? `${lake.name} ${lake.letter_number}` : lake.letter_number}${noFishEmoji}`;
            
            content.innerHTML = `
                <!-- Lake Info -->
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <h3 class="text-lg font-semibold mb-3">Lake Information</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-medium">Drainage:</span> ${lake.drainage}</div>
                        <div><span class="font-medium">Size:</span> ${lake.size_acres ? `${lake.size_acres} acres` : 'Unknown'}</div>
                        <div><span class="font-medium">Max Depth:</span> ${lake.max_depth_ft ? `${lake.max_depth_ft} ft` : 'Unknown'}</div>
                        <div><span class="font-medium">Elevation:</span> ${lake.elevation_ft ? `${lake.elevation_ft.toLocaleString()} ft` : 'Unknown'}</div>
                        <div><span class="font-medium">Fishing Pressure:</span> ${lake.fishing_pressure || 'Unknown'}</div>
                        <div class="col-span-2"><span class="font-medium">Fish Species:</span> ${lake.fish_species || 'Unknown'}</div>
                        ${lake.status ? `<div class="col-span-2"><span class="font-medium">Status:</span> ${getStatusButton(lake.status, true)}</div>` : ''}
                        ${lake.jed_notes ? `<div class="col-span-2"><span class="font-medium">Jed's Notes:</span> ${lake.jed_notes}</div>` : ''}
                    </div>
                </div>

                <!-- Stocking Records -->
                <div class="rounded-lg p-4 border border-slate-200">
                    <h3 class="text-lg font-semibold mb-3">Stocking Records</h3>
                    ${lakeStocking.length > 0 ? `
                        <div class="space-y-2">
                            ${lakeStocking.map(record => {
                                const date = new Date(record.stock_date);
                                const year = date.getFullYear();
                                const month = date.toLocaleDateString('en-US', { month: 'short' });
                                const day = date.getDate();
                                // Species are already normalized in the database
                                const speciesClean = record.species;
                                return `
                                <div class="text-sm p-2 text-gray-700">
                                    ${year} ${month} ${day} - ${record.quantity} ${speciesClean}, ${record.length || '?'}"
                                </div>
                                `;
                            }).join('')}
                        </div>
                    ` : '<p class="text-gray-600">No stocking records available</p>'}
                </div>

                <!-- Notes from Junesucker.com -->
                ${lake.junesucker_notes ? `
                    <div class="rounded-lg p-4 border border-slate-200">
                        <h3 class="text-lg font-semibold mb-3">Notes from Junesucker.com</h3>
                        ${lakePhotos.length > 0 ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                ${lakePhotos.map(photo => `
                                    <img src="${photo.downloaded_path}" 
                                         alt="${lake.name || lake.letter_number} photo" 
                                         class="w-full rounded-lg border border-slate-300 hover:scale-105 transition-transform cursor-pointer"
                                         onclick="window.open('${photo.downloaded_path}', '_blank')">
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="text-gray-700 leading-relaxed">${lake.junesucker_notes.replace(/^## (.+)$/gm, '<h6 class="font-semibold text-base mt-4 mb-1">$1</h6>').replace(/\n/g, '<br>')}</div>
                    </div>
                ` : ''}

                <!-- DWR Notes -->
                ${lake.dwr_notes ? `
                    <div class="rounded-lg p-4 border border-slate-200">
                        <h3 class="text-lg font-semibold mb-3">Historical DWR Notes</h3>
                        <div class="text-gray-700 leading-relaxed">${lake.dwr_notes.replace(/\n/g, '<br>')}</div>
                    </div>
                ` : ''}

                <!-- Fishing Reports (commented out - requires server-side persistence) -->
                <!--
                <div class="rounded-lg p-4 border border-slate-200">
                    <h3 class="text-lg font-semibold mb-3">Fishing Reports</h3>
                    <p class="text-gray-600 mb-3">No fishing reports yet</p>
                </div>
                -->

                <!-- Jed's Notes (commented out - requires server-side persistence) -->
                <!--
                <div class="rounded-lg p-4 border border-slate-200">
                    <h3 class="text-lg font-semibold mb-3">Jed's Notes</h3>
                </div>
                -->
            `;
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('lake-detail-modal').classList.add('hidden');
        }

        function openAboutModal() {
            document.getElementById('about-modal').classList.remove('hidden');
        }

        function closeAboutModal() {
            document.getElementById('about-modal').classList.add('hidden');
        }

        // Note: Fishing reports and lake editing features commented out
        // They require server-side persistence which isn't available in this static web app

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                        
                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New update available
                                    if (confirm('New version available! Refresh to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Show install prompt for PWA (iOS doesn't support this, but good for other platforms)
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button or banner
            console.log('PWA install prompt available');
        });

        // Detect if app is running as PWA
        function isPWA() {
            return window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
        }

        // Show iOS install instructions
        function showIOSInstallInstructions() {
            if (!isPWA() && /iPad|iPhone|iPod/.test(navigator.userAgent)) {
                const banner = document.createElement('div');
                banner.id = 'ios-install-banner';
                banner.className = 'fixed top-0 left-0 right-0 bg-blue-600 text-white p-3 text-center text-sm z-50';
                banner.innerHTML = `
                    <div>üì± Add to Home Screen for offline access: Tap <strong>Share</strong> ‚Üí <strong>Add to Home Screen</strong></div>
                    <button onclick="document.getElementById('ios-install-banner').remove()" class="absolute right-2 top-2 text-xl">&times;</button>
                `;
                document.body.appendChild(banner);
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    banner?.remove();
                }, 10000);
            }
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            initApp();
            setTimeout(showIOSInstallInstructions, 2000); // Show after app loads
        });
    </script>
</body>
</html>