<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Test - Uintas ðŸ’¯</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .pass { background-color: #d4edda; }
        .fail { background-color: #f8d7da; }
        .pending { background-color: #fff3cd; }
    </style>
</head>
<body>
    <h1>PWA Test Results</h1>
    <div id="tests"></div>
    
    <script>
        const tests = [];
        
        function addTest(name, testFn) {
            tests.push({ name, testFn });
        }
        
        async function runTest(test) {
            try {
                const result = await test.testFn();
                return result === true ? 'pass' : (result === false ? 'fail' : 'pending');
            } catch (error) {
                console.error(`Test "${test.name}" failed:`, error);
                return 'fail';
            }
        }
        
        async function displayResults() {
            const container = document.getElementById('tests');
            
            // Show initial pending state
            container.innerHTML = tests.map(test => `
                <div class="test pending" id="test-${test.name.replace(/\s+/g, '-').toLowerCase()}">
                    <strong>${test.name}</strong>: PENDING
                </div>
            `).join('');
            
            // Run tests one by one and update results
            for (const test of tests) {
                const testId = `test-${test.name.replace(/\s+/g, '-').toLowerCase()}`;
                const testElement = document.getElementById(testId);
                
                try {
                    const status = await runTest(test);
                    testElement.className = `test ${status}`;
                    testElement.innerHTML = `<strong>${test.name}</strong>: ${status.toUpperCase()}`;
                } catch (error) {
                    testElement.className = 'test fail';
                    testElement.innerHTML = `<strong>${test.name}</strong>: FAIL (${error.message})`;
                }
                
                // Small delay to show progression
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        // Define tests
        addTest('Service Worker Support', () => 'serviceWorker' in navigator);
        
        addTest('Manifest Present', async () => {
            try {
                const response = await fetch('./manifest.json');
                return response.ok;
            } catch (e) {
                return false;
            }
        });
        
        addTest('Service Worker Registered', async () => {
            if (!('serviceWorker' in navigator)) return false;
            
            // Check if already registered
            if (navigator.serviceWorker.controller) return true;
            
            // Wait for registration to complete (up to 5 seconds)
            for (let i = 0; i < 50; i++) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    // Wait a bit more for activation
                    await new Promise(resolve => setTimeout(resolve, 200));
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            return false;
        });
        
        addTest('Database Accessible', async () => {
            try {
                const response = await fetch('./uinta_lakes.db');
                return response.ok;
            } catch (e) {
                return false;
            }
        });
        
        addTest('Icons Present', async () => {
            try {
                const icon192 = await fetch('./icon-192.png');
                const icon512 = await fetch('./icon-512.png');
                const iconApple = await fetch('./icon-180.png');
                return icon192.ok && icon512.ok && iconApple.ok;
            } catch (e) {
                return false;
            }
        });
        
        addTest('PWA Meta Tags', () => {
            const hasViewport = document.querySelector('meta[name="viewport"]') !== null;
            const hasAppleCapable = document.querySelector('meta[name="apple-mobile-web-app-capable"]') !== null;
            const hasThemeColor = document.querySelector('meta[name="theme-color"]') !== null;
            return hasViewport; // Just test basic one for this test page
        });
        
        // Initialize tests when page loads
        window.addEventListener('load', async () => {
            // Show initial pending state
            displayResults();
            
            // Register service worker first if needed
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('Service worker registered for test:', registration.scope);
                    
                    // Wait for service worker to activate
                    if (registration.installing) {
                        await new Promise(resolve => {
                            registration.installing.addEventListener('statechange', function() {
                                if (this.state === 'activated') {
                                    resolve();
                                }
                            });
                        });
                    }
                } catch (e) {
                    console.error('Service worker registration failed:', e);
                }
            }
            
            // Wait a moment for everything to settle, then run tests
            setTimeout(() => {
                displayResults();
            }, 500);
        });
    </script>
</body>
</html>